#!/bin/sh -xe

git config user.email "continuous.integration@intellihr.com.au"
git config user.name "IntelliHR CI"

echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > .npmrc

npm version $RELEASE_VERSION -m "[skip ci] Upgrade to %s"
npm publish --access public

git remote add gitlab https://$GIT_USERNAME:$GIT_TOKEN@gitlab.com/intellihr/ui-components.git
git fetch gitlab master develop
git push --follow-tags gitlab HEAD:master
git rebase gitlab/master gitlab/develop

sed -i -r "s/\sRELEASE_VERSION.*/ RELEASE_VERSION: $DEFAULT_RELEASE_VERSION/" .gitlab-ci.yml

if ! git diff-index --quiet HEAD --; then
  git add .gitlab-ci.yml
  git commit -m "Reset to default release version"
fi

git push gitlab HEAD:develop
